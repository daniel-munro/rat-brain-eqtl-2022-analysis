---
title: "Shuffled sample eGene overlap"
output:
  html_notebook: 
    code_folding: hide
  html_document:
    df_print: paged
---

Overlap of eGenes among brain regions is enriched against the null hypothesis of uniformly random selections of genes, but this is not surprising since we know that (1) different genes have different capacities for eQTL detection due to the variation present in their cis-windows, and (2) a lot of cis-regulatory activity is shared across tissues, especially across brain regions.

Brain region specificity of significant eGenes can be caused by biological differences between regions that is detectable in gene expression profiles. But it can also be caused by eQTLs passing the significance threshold for some regions and not others simply due to stochasticity in the sets of ~80 samples.

To estimate the extent of brain region-specific eQTLs due to true biological region differences, I'll compare the observed specificity to that for region-shuffled expression data. That is, for each rat, shuffle the sample labels for its 4-5 samples to get 5 "pseudoregion" expression datasets that include the same rats (therefore are the same size) as the originals, but are from a mixture of ragions.

I'll do cis-eQTL mapping on these, and repeat for multiple permutations. The amount of region specificity seen in those results reflect random sampling imbalances, and the additional level of region specificity in the real data should reflect cis-eQTL-relevant expression differences across regions.

```{r}
library(tidyverse)

perm <- crossing(perm = 0:2,
              region = c("Acbc", "IL", "LHB", "PL", "VoLo")) %>%
    group_by(perm, region) %>%
    summarise(
        read_tsv(str_glue("../data/tensorqtl/shuf/{perm}/{region}.cis_qtl.txt.gz"),
                 col_types = "c----------------d-") %>%
            filter(qval < 0.05) %>%
            select(gene_id = phenotype_id),
        .groups = "drop"
    )

actual <- crossing(region = c("Acbc", "IL", "LHB", "PL", "VoLo")) %>%
    group_by(region) %>%
    summarise(
        read_tsv(
            str_glue("../data/tensorqtl/{str_sub(region, 1, 1)}QCT.cis_qtl.txt.gz"),
            col_types = "c----------------d-"
        ) %>%
            filter(qval < 0.05) %>%
            select(gene_id = phenotype_id),
        .groups = "drop"
    ) %>%
    mutate(perm = -1L)

d <- bind_rows(perm, actual)
```

Real data (perm -1) has more total unique eGenes:

```{r}
d %>%
    distinct(perm, gene_id) %>%
    count(perm)
```

It also has more eGenes per region:

```{r}
ggplot(d, aes(x = perm, fill = region)) +
    geom_bar(position = "dodge")
```


<!-- ```{r} -->
<!-- d %>% -->
<!--     count(perm, gene_id) %>% -->
<!--     ggplot(aes(x = n)) + -->
<!--     facet_wrap("~ perm") + -->
<!--     geom_bar() -->
<!-- ``` -->

But the shuffled pseudoregions still had more universal eGenes:

```{r}
perm_counts <- perm %>%
    count(perm, gene_id) %>%
    count(perm, n, name = "nn")
actual %>%
    count(gene_id) %>%
    ggplot(aes(x = n)) +
    geom_bar(fill = "#aaaaaa") +
    ggbeeswarm::geom_beeswarm(aes(x = n, y = nn), data = perm_counts, cex = 3) +
    theme_minimal() +
    ggtitle("eGene overlap among regions",
            subtitle = "Bars are for actual data, points are for shuffled data") +
    xlab("Number of regions in which each eGene is found") +
    ylab("Number of eGenes")
```

We can also look at the effect of shuffling on individual eGenes. If a gene is an eGene in X regions, in how many pseudoregions, on average, is it an eGene after shuffling?

```{r}
perm %>%
    count(gene_id) %>%
    mutate(mean_regions = n / n_distinct(perm$perm)) %>%
    select(-n) %>%
    full_join(count(actual, gene_id), by = "gene_id") %>%
    replace_na(list(mean_regions = 0, n = 0)) %>%
    mutate(n = as.factor(n)) %>%
    ggplot(aes(x = n, y = mean_regions)) +
    # geom_point()
    # ggbeeswarm::geom_beeswarm()
    geom_boxplot(outlier.size = 0.5) +
    xlab("# of regions in which eGene is found in actual data") +
    ylab("mean # of shuffled pseudoregions") +
    ggtitle("Effect of shuffling on occurrence of each eGene",
            subtitle = "Excludes genes that aren't eGenes in any actual or shuffled data")
```

